if (!rootProject.hasProperty('useAntlr4')) return

apply plugin: 'me.champeau.gradle.antlr4'

def srcBase = "subprojects/groovy-antlr4-grammar/src"
def srcMain = "$srcBase/main"
def srcTest = "$srcBase/test"
def antlr4Source = "$srcMain/antlr4"
def antlr4OutputRootDir = "$buildDir/generated-sources"
def antlr4Output = "$antlr4OutputRootDir/org/apache/groovy/parser/antlr4"

// set package for antlr generated classes
antlr4 {
    source = file(antlr4Source)
    extraArgs = ["-no-listener", "-package", "org.apache.groovy.parser.antlr4"]
    output = file(antlr4Output)
}

// make the Java compile task depend on the antlr4 task
compileJava.dependsOn antlr4

// add antlr4 to classpath
configurations {
   compile.extendsFrom antlr4
}

dependencies {
    antlr4 "com.tunnelvisionlabs:antlr4:$antlr4Version"
    testCompile project(':groovy-test')
}


task cleanGeneratedSources(type: Delete) {
    delete antlr4OutputRootDir
    file(antlr4OutputRootDir).mkdirs()
}

antlr4.dependsOn cleanGeneratedSources

// add the generated source files to the list of java sources
sourceSets.main.java.srcDirs += file("$antlr4OutputRootDir");
sourceSets.main.java.srcDirs += file("$srcMain/java");
sourceSets.main.groovy.srcDirs += file("$srcMain/groovy");
sourceSets.main.resources.srcDirs += file("$antlr4Source");
sourceSets.main.resources.srcDirs += file("$srcMain/resources");
sourceSets.test.java.srcDirs += file("$srcTest/java");
sourceSets.test.groovy.srcDirs += file("$srcTest/groovy");
sourceSets.test.resources.srcDirs += file("$srcTest/resources");


allprojects {
   tasks.withType(GroovyCompile) {
        groovyOptions.forkOptions.jvmArgs += ["-Dgroovy.antlr4=true"]
    }
}
